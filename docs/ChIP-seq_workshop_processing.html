<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Analysing High Throughput Sequencing Data - Processing Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./images/DRP_Logo_only_square_transparent.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Analysing High Throughput Sequencing Data</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./ChIP-seq_workshop_processing.html" aria-current="page">
 <span class="menu-text">Processing</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./ChIP-seq_workshop_analysis.html">
 <span class="menu-text">Analysis</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#getting-started" id="toc-getting-started" class="nav-link active" data-scroll-target="#getting-started">1. Getting Started</a>
  <ul class="collapse">
  <li><a href="#logging-in" id="toc-logging-in" class="nav-link" data-scroll-target="#logging-in">Logging in</a></li>
  <li><a href="#creating-a-web-directory" id="toc-creating-a-web-directory" class="nav-link" data-scroll-target="#creating-a-web-directory">Creating A Web Directory</a></li>
  <li><a href="#chip-seq-sequencing-data" id="toc-chip-seq-sequencing-data" class="nav-link" data-scroll-target="#chip-seq-sequencing-data">ChIP-seq sequencing data</a></li>
  <li><a href="#obtaining-data" id="toc-obtaining-data" class="nav-link" data-scroll-target="#obtaining-data">Obtaining data</a></li>
  <li><a href="#integrative-genomics-viewer" id="toc-integrative-genomics-viewer" class="nav-link" data-scroll-target="#integrative-genomics-viewer">Integrative Genomics Viewer</a></li>
  </ul></li>
  <li><a href="#quality-control" id="toc-quality-control" class="nav-link" data-scroll-target="#quality-control">2. Quality Control</a>
  <ul class="collapse">
  <li><a href="#fastq-files" id="toc-fastq-files" class="nav-link" data-scroll-target="#fastq-files">FastQ files</a></li>
  <li><a href="#fastq-screen" id="toc-fastq-screen" class="nav-link" data-scroll-target="#fastq-screen">FastQ screen</a></li>
  <li><a href="#fastqc" id="toc-fastqc" class="nav-link" data-scroll-target="#fastqc">FastQC</a></li>
  <li><a href="#multiqc" id="toc-multiqc" class="nav-link" data-scroll-target="#multiqc">MultiQC</a></li>
  <li><a href="#parallelisation" id="toc-parallelisation" class="nav-link" data-scroll-target="#parallelisation">Parallelisation</a></li>
  <li><a href="#parallel" id="toc-parallel" class="nav-link" data-scroll-target="#parallel">parallel</a></li>
  <li><a href="#pre-processing-quality-trimming-and-adapter-removal" id="toc-pre-processing-quality-trimming-and-adapter-removal" class="nav-link" data-scroll-target="#pre-processing-quality-trimming-and-adapter-removal">Pre-processing: Quality trimming and adapter removal</a></li>
  <li><a href="#cutadapt" id="toc-cutadapt" class="nav-link" data-scroll-target="#cutadapt">Cutadapt</a></li>
  <li><a href="#other-qc-software-worth-investigating" id="toc-other-qc-software-worth-investigating" class="nav-link" data-scroll-target="#other-qc-software-worth-investigating">Other QC software worth investigating</a></li>
  </ul></li>
  <li><a href="#mapping-and-filtering" id="toc-mapping-and-filtering" class="nav-link" data-scroll-target="#mapping-and-filtering">3. Mapping and Filtering</a>
  <ul class="collapse">
  <li><a href="#read-alignment" id="toc-read-alignment" class="nav-link" data-scroll-target="#read-alignment">Read Alignment</a></li>
  <li><a href="#genome-assemblies-and-indexing" id="toc-genome-assemblies-and-indexing" class="nav-link" data-scroll-target="#genome-assemblies-and-indexing">Genome assemblies and indexing</a></li>
  <li><a href="#mapping-reads-with-bwa" id="toc-mapping-reads-with-bwa" class="nav-link" data-scroll-target="#mapping-reads-with-bwa">Mapping reads with BWA</a></li>
  <li><a href="#sambamcram-format-and-samtools" id="toc-sambamcram-format-and-samtools" class="nav-link" data-scroll-target="#sambamcram-format-and-samtools">SAM/BAM/CRAM format and Samtools</a></li>
  </ul></li>
  <li><a href="#post-processing" id="toc-post-processing" class="nav-link" data-scroll-target="#post-processing">4. Post Processing</a>
  <ul class="collapse">
  <li><a href="#filtering-reads-with-samtools" id="toc-filtering-reads-with-samtools" class="nav-link" data-scroll-target="#filtering-reads-with-samtools">Filtering reads with samtools</a></li>
  <li><a href="#multimap-reads-and-duplicate-reads" id="toc-multimap-reads-and-duplicate-reads" class="nav-link" data-scroll-target="#multimap-reads-and-duplicate-reads">Multimap reads and Duplicate reads</a></li>
  <li><a href="#genome-blacklists" id="toc-genome-blacklists" class="nav-link" data-scroll-target="#genome-blacklists">Genome blacklists</a></li>
  <li><a href="#how-many-reads" id="toc-how-many-reads" class="nav-link" data-scroll-target="#how-many-reads">How many reads?</a></li>
  </ul></li>
  <li><a href="#visualisation" id="toc-visualisation" class="nav-link" data-scroll-target="#visualisation">5. Visualisation</a>
  <ul class="collapse">
  <li><a href="#converting-bam-files-to-bigwig-tracks" id="toc-converting-bam-files-to-bigwig-tracks" class="nav-link" data-scroll-target="#converting-bam-files-to-bigwig-tracks">Converting BAM files to bigWig tracks</a></li>
  <li><a href="#integrative-genomics-viewer-igv" id="toc-integrative-genomics-viewer-igv" class="nav-link" data-scroll-target="#integrative-genomics-viewer-igv">Integrative Genomics Viewer (IGV)</a></li>
  <li><a href="#other-genome-browsers" id="toc-other-genome-browsers" class="nav-link" data-scroll-target="#other-genome-browsers">Other genome browsers</a></li>
  <li><a href="#tidy-up" id="toc-tidy-up" class="nav-link" data-scroll-target="#tidy-up">Tidy Up!</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Processing Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>


<script src="https://kit.fontawesome.com/ece750edd7.js" crossorigin="anonymous"></script>

<!-- 

::: key-points
<h2><i class="fas fa-thumbtack"></i> Key points:</h2>

-   test
:::

::: discussion
<h2><i class="far fa-bell"></i> Discussion</h2>

-   test
:::

::: resources
<h2><i class="fas fa-book"></i> Further Learning</h2>

-   test
:::

::: challenge
<h2><i class="fas fa-pencil-alt"></i> Challenge:</h2>

test
:::

-->
<div class="objectives">
<h2 class="anchored">
<i class="far fa-check-square"></i> Learning Objectives
</h2>
<ul>
<li><p>Set up a project folder</p></li>
<li><p>Assess quality of sequence data</p></li>
<li><p>Align reads to a reference genome and perform post alignment filtering</p></li>
<li><p>View read coverage profiles and alignments in a genome browser</p></li>
</ul>
</div>
<section id="getting-started" class="level2">
<h2 class="anchored" data-anchor-id="getting-started">1. Getting Started</h2>
<p>We are using the Linux command line to run most of the tools we use today. If you are new to Linux a good starting point is the Introduction to Linux <a href="https://swebb1.github.io/Intro_to_Linux/">Workshop</a>.</p>
<p><br></p>
<section id="logging-in" class="level3">
<h3 class="anchored" data-anchor-id="logging-in">Logging in</h3>
<p>We have several servers that you can login to. For the purpose of this practical we will use bifx-core2. No matter where you login, you will have access to the same files and programs. bifx-core3 is also available, both bifx-core2 and bifx-core3 require you to use a VPN.</p>
<p>There are several options to login to our machines. You can use the <strong>Terminal</strong> app on a Mac or equivalant <strong>Command Prompt</strong> or MobaXTerm on Windows. Login via <strong>X2G0</strong> if you want a graphical interface.</p>
<p>To login via command line: ssh USER@bifx-core2.bio.ed.ac.uk</p>
<p>Login with your user credentials (the same as EASE)</p>
<p>If you are using MobaXTerm, an alternative way of logging in to the server is shown in the MobaXTerm demo.</p>
<p>Once you have typed in your password, you should see some welcome text and a prompt that looks something like this:</p>
<p>[USERNAME]<span class="citation" data-cites="bifx-core2">@bifx-core2</span>:~$</p>
<!--Alternatively you can use **RStudio** which is an environment built for R programming but also gives you access to the command line terminal, your file structure and several other graphical features. 

1. Open this link in a new window: [bifx-rta.bio.ed.ac.uk](http://bifx-rta.bio.ed.ac.uk:8787)
2. Login with your user credentials for our servers (not the same as EASE)
3. Familiarise yourself with the different panels and locate the Terminal. -->
<p><br></p>
</section>
<section id="creating-a-web-directory" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-web-directory">Creating A Web Directory</h3>
<p>In order to view files created on the server, we need to create a public_html directory.</p>
<p>After logging in you should be in your $HOME directory, check with;</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">pwd</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This should show the PATH of your present working directory, which should now be your home directory as you have just logged in. You can return to this place at any time using the change directory command.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You have permissions to create files and directories under your home folder. Lets create some now which we will use later on.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> ~/public_html</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> ~/public_html/TMP</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here we have used the absolute path name for each directory using ~/ as a shortcut for your $HOME directory. Nested directories are separated by the forward slash ‘/’ sign.</p>
<p>As you have created ~/public_html, contents of this directory are available online with any web browser</p>
<p>To see it enter the following URL, changing yourUserName to what ever your username is.</p>
<p>http://bifx-core3.bio.ed.ac.uk/~yourUserName</p>
<p>For some users this may be under; https://bifx-core3.bio.ed.ac.uk/Public/yourUserName</p>
<p><br></p>
</section>
<section id="chip-seq-sequencing-data" class="level3">
<h3 class="anchored" data-anchor-id="chip-seq-sequencing-data">ChIP-seq sequencing data</h3>
<p>The datasets used in this exercise are derived from a single end ChIP-seq experiment (actually ChIP-exo) in <em>S.cerevisiae</em>. There are 2 biological replicates (though we recommend using 3 or more!) Reb1_R1 and Reb1_R2 as well as their corresponding input controls Input_R1 and Input_R2. For this experiment immunoprecipitation was performed with antibodies against Reb1. Reb1 recognizes a specific sequence (TTACCCG) and is involved in many aspects of transcriptional regulation by all three yeast RNA polymerases and promotes formation of nucleosome-free regions (NFRs). You can find the original publication <a href="http://www.sciencedirect.com/science/article/pii/S0092867411013511">here</a>. For the purpose of this workshop we have randomly subsampled and filtered out poor quality reads to speed up runtime.</p>
<table class="table">
<thead>
<tr class="header">
<th>Dataset</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Reb1_R1</td>
<td>ChIP experiment, replicate 1</td>
</tr>
<tr class="even">
<td>Reb1_R2</td>
<td>ChIP experiment, replicate 2</td>
</tr>
<tr class="odd">
<td>Input_R1</td>
<td>Input DNA, replicate 1</td>
</tr>
<tr class="even">
<td>Input_R2</td>
<td>Input DNA, replicate 2</td>
</tr>
</tbody>
</table>
<p><br></p>
</section>
<section id="obtaining-data" class="level3">
<h3 class="anchored" data-anchor-id="obtaining-data">Obtaining data</h3>
<p>First, make a new directory for this tutorial and move into that directory. Then link the directory to your public html folder as we are going to make everything public in this tutorial.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> ChIP-seq_workshop</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ChIP-seq_workshop</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-s</span> <span class="va">$PWD</span> ~/public_html/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Next, create a subfolder called <strong>fastq</strong> for all of our sequence files and link the raw datasets to this folder:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> fastq</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /home/library/training/ChIP-seq_workshop/data/<span class="pp">*</span>fq.gz fastq/.</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When you receive data from a sequencing centre the file should also be provided with an alphanumeric string known as an <strong>md5 checksum</strong>. We can think of this as a files passport or fingerprint and use it to verify our data and ensure it wasn’t corrupted or truncated during download. The md5 checksums for these files are below. Lets check that now using the <code>md5sum</code> command:</p>
<table class="table">
<thead>
<tr class="header">
<th>md5 checksum</th>
<th>filename</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>914b4dda687a76b0d50e545e3ce705d6</td>
<td>Input_R1.fq.gz</td>
</tr>
<tr class="even">
<td>f421ed18b71a801b236612cdde49dbaf</td>
<td>Input_R2.fq.gz</td>
</tr>
<tr class="odd">
<td>dd363301ad237ecb6c81c59ae97995a2</td>
<td>Reb1_R1.fq.gz</td>
</tr>
<tr class="even">
<td>06623f9e556876dd6c4d1dfdc4348698</td>
<td>Reb1_R2.fq.gz</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> fastq <span class="co">#Move into the fastq directory</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">md5sum</span> <span class="pp">*</span>.fq.gz <span class="op">&gt;</span> md5</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> md5 <span class="co">#prints out the contents of md5</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#To check the files and md5 sums match at any time</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">md5sum</span> <span class="at">-c</span> md5 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
</section>
<section id="integrative-genomics-viewer" class="level3">
<h3 class="anchored">Integrative Genomics Viewer</h3>
<p>Later we will use the Integrative Genomics Viewer (<a href="https://software.broadinstitute.org/software/igv/download">IGV</a>), please install this on your own machine, alternatively you can use the <a href="https://igv.org/app/">App</a>.</p>
<div class="key-points">
<h2 class="anchored" data-anchor-id="integrative-genomics-viewer">
<i class="fas fa-thumbtack"></i>Key Points:
</h2>
<ul>
<li>Log in to the bifx servers</li>
<li>Create a personal web directory</li>
<li>Create a project directory for fastq files</li>
<li>Running IGV</li>
</ul>
</div>
<p><br></p>
</section>
</section>
<section id="quality-control" class="level2">
<h2 class="anchored" data-anchor-id="quality-control">2. Quality Control</h2>
<section id="fastq-files" class="level3">
<h3 class="anchored" data-anchor-id="fastq-files">FastQ files</h3>
<p>Sequencing data will typically be provided to you in fastq format (.fq or .fastq) or as a compressed gzipped fastq (.fq.gz) in order to save space. We can view a gzipped file with the zless command, let’s take a look:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ChIP-seq_workshop/fastq <span class="co"># Move into the fastq directory (if not already)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">zless</span> Input_R1.fq.gz <span class="kw">|</span> <span class="fu">head</span> <span class="at">-n</span> 12</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="https://en.wikipedia.org/wiki/FASTQ_format">Fastq</a> files contain 4 lines per sequenced read:</p>
<ul>
<li>Line 1 begins with an ‘@’ character and is followed by a sequence identifier and an optional description</li>
<li>Line 2 is the raw sequence</li>
<li>Line 3 begins with a ‘+’ character and is optionally followed by the same sequence identifier</li>
<li>Line 4 encodes the Phred quality score for the sequence in Line 2 as ASCII characters</li>
</ul>
<p>Phred Quality Score Base Call Error Probability:</p>
<table class="table">
<thead>
<tr class="header">
<th>Score</th>
<th>Probability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Q40</td>
<td>0.0001 (1 in 10,000)</td>
</tr>
<tr class="even">
<td>Q30</td>
<td>0.001 (1 in 1,000)</td>
</tr>
<tr class="odd">
<td>Q20</td>
<td>0.01 (1 in 100)</td>
</tr>
<tr class="even">
<td>Q10</td>
<td>0.1 (1 in 10)</td>
</tr>
</tbody>
</table>
<p><br></p>
<p>First we want to assess the quality of our sequencing data and check for any biases and contamination.</p>
<p><br></p>
</section>
<section id="fastq-screen" class="level3">
<h3 class="anchored" data-anchor-id="fastq-screen">FastQ screen</h3>
<p>When running a sequencing pipeline it is useful to know that your sequencing runs contain the types of sequence they’re supposed to. <a href="http://www.bioinformatics.babraham.ac.uk/projects/fastq_screen/">FastQ Screen</a> allows you to set up a standard set of libraries against which all of your sequences can be searched. Your search libraries might contain the genomes of all of the organisms you work on, along with PhiX, Vectors or other contaminants commonly seen in sequencing experiments. We will run a screen of our sequences against human, mouse, rat, e.coli and s.cerevisiae (defaults):</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> .. <span class="co">#Move up a directory again</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">fastq_screen</span> <span class="at">--conf</span> /home/genomes/tool_configs/fastq_screen/fastq_screen.conf fastq/<span class="pp">*</span>fq.gz <span class="at">--outdir</span> fastq</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># * is a wild card character</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Once complete take a look at the output images in your browser via your public html folder. This shows that most of your reads align to the yeast genome and that no reads align uniquely to other organisms: <!--Update pic here?--> <img src="images/Reb1_R1_screen.png" width="1200"></p>
<p><br></p>
</section>
<section id="fastqc" class="level3">
<h3 class="anchored" data-anchor-id="fastqc">FastQC</h3>
<p><a href="http://www.bioinformatics.babraham.ac.uk/projects/fastqc/">FastQC</a> provides simple quality control checks on raw sequence data coming from high throughput sequencing pipelines. It provides a modular set of analyses which you can use to get a quick impression of whether your data has any problems of which you should be aware before proceeding.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">fastqc</span> fastq/<span class="pp">*</span>.fq.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>FastQC will create report files for each of your datasets which we can view in the browser. We will go through each of the images during the workshop. For future reference, specific guidance on how to interpret the output of each module is provided in the <a href="http://www.bioinformatics.babraham.ac.uk/projects/fastqc/Help/">fastqc help pages</a>.</p>
<p>An example of poor quality sequencing at the end of short reads:</p>
<p><img src="images/Poor_sequence_quality.png" width="700"></p>
<p>The software gives a <em>pass</em>, <em>fail</em> or <em>warning</em> flag for each test based on what we would expect from a regular DNA-sequencing run. It is important to realise that FastQC does not understand the origin of your data and that different datasets will have different characteristics. For instance RNA sequencing often involves the use of <strong>random hexamer primers</strong> that are <a href="https://sequencing.qcfail.com/articles/positional-sequence-bias-in-random-primed-libraries/">not as random as you might expect</a>. The profile below in the first ~15 bases is perfectly normal for these samples but will be flagged as an error by FastQC:</p>
<p><img src="images/Random_hexamer_priming.png" width="700"></p>
<p>Bisulfite treatment (used to investigate DNA methylation) converts most Cs in the genome to Ts, as we can see below. FastQC will not be happy with this profile, the point is, understand what you have sequenced and what you expect to see rather than blindly trusting the FastQC flag system!</p>
<p><img src="images/bisulfite.png" width="700"></p>
<p>Visit the <a href="https://sequencing.qcfail.com/author/simon/">QCFail</a> website for more examples and advice on quality control for NGS datasets.</p>
<p><br></p>
</section>
<section id="multiqc" class="level3">
<h3 class="anchored" data-anchor-id="multiqc">MultiQC</h3>
<p>We can view summaries of multiple reports at once by using <a href="http://multiqc.info/">multiqc</a>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">multiqc</span> <span class="at">-o</span> fastq fastq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>MultiQC searches for report files in a directory and compiles them into a single report. Open the multiqc report via a web browser to see how the raw datasets compare. Here we have the output of FastQ_screen and FastQC, but MultiQC works with the outputs of many tools other tools which we’ll see later.</p>
<p>If we look at the <em>adapter content</em> and <em>over represented sequences</em> sections we can see a small amount of contamination particularly in the second replicates.</p>
<p><br></p>
</section>
<section id="parallelisation" class="level3">
<h3 class="anchored" data-anchor-id="parallelisation">Parallelisation</h3>
<p>Up until now we have run command line tools on each one of our datasets in serial, this means they run one after the other. In this tutorial we only have a few small datasets and the tools run relatively quickly, but this approach won’t scale well to multiple large datasets. A more efficient approach is to run all of our datasets in <strong>parallel</strong>, later we will create a <strong>script</strong>.</p>
<p><br></p>
</section>
<section id="parallel" class="level3">
<h3 class="anchored">parallel</h3>
<p>Unix has a program called <strong>parallel</strong> which allows you to run tools on multiple datasets at the same time. The following command would list all of your gzipped fastq files and pipe them into parallel.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> fastq/<span class="pp">*</span>fq.gz <span class="kw">|</span> <span class="ex">parallel</span> <span class="at">-j</span> 4 fastqc {} <span class="kw">&amp;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ps</span> f</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><em>ls</em> lists files ending with .fq.gz in your fastq directory and pipes the names in to parallel</li>
<li>The parallel <em>-j</em> flag stands for <em>juggle</em> and tells parallel to run 4 processes at the same time.</li>
<li>In this case we are running fastqc and the <em>{}</em> is a place holder for the filenames we are piping in.</li>
<li>The <em>&amp;</em> character runs these jobs in the background so we can continue to use the terminal.</li>
<li><em>ps</em> is the <em>process status</em> tool which shows jobs running in the current session, we should see 4 instances of fastqc running.</li>
</ul>
<p><br></p>
<p>First, let’s create a file that lists our sample names so we can feed this into parallel. We could just type this manually, but here fastq files are ‘piped’ into parallel as above but we use regular expression within ‘sed’ to remove the name ending, this can now be used to name all files.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> fastq/<span class="pp">*</span>fq.gz <span class="kw">|</span> <span class="ex">parallel</span> basename <span class="kw">|</span> <span class="fu">sed</span> s/.fq.gz// <span class="op">&gt;</span> samples.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<div class="challenge">
<h2 class="anchored" data-anchor-id="parallel">
<i class="fas fa-pencil-alt"></i> Challenge:
</h2>
<p>See if you can adapt the FastQC command to use the samples.txt file in parallel.</p>
</div>
<div class="challenge">
<p><strong>Hint:</strong> <code>cat samples.txt</code> will print the names of the samples.</p>
<details>
<summary>
Solution
</summary>
<div class="solution proof">
<p><span class="proof-title"><em>Solution</em>. </span></p>
<h2 class="anchored">
<i class="far fa-eye"></i>
</h2>
<p><code>cat samples.txt | parallel -j 4 fastqc fastq/{}.fq.gz</code></p>
</div>
</details>
</div>
<p><br></p>
</section>
<section id="pre-processing-quality-trimming-and-adapter-removal" class="level3">
<h3 class="anchored" data-anchor-id="pre-processing-quality-trimming-and-adapter-removal">Pre-processing: Quality trimming and adapter removal</h3>
<p>From the FastQC report we can see that the overall quality of our sequencing is good, however it is good practice to perform some pre-processing and filtering of reads. Poor quality sequencing can make a read less alignable so it is good practice to <strong>quality trim</strong> the ends of reads until we get to the high quality portion. Trimming is not always neccessary as some mapping programs will trim the reads for you or perform <strong>soft clipping</strong> where only part of a read is required to align but studies have shown that pre-processing generally improves alignment rate if done correctly.</p>
<p>Sequencing libraries are normally constructed by ligating adapters to fragments of DNA or RNA. If your read length is longer than your fragment then <a href="https://sequencing.qcfail.com/articles/read-through-adapters-can-appear-at-the-ends-of-sequencing-reads/">sequenced reads will contain the adapter sequence</a>. <strong>Adapter removal</strong> is also a necessary consideration for your QC workflow, especially if adapters are detected by FastQC.</p>
<p>An example of adapter contamination at the end of reads: <img src="images/Adapter_contamination.png" width="700"></p>
<p>Once reads have been trimmed they will vary in length. You may want to <strong>filter</strong> out reads that are now too short to be uniquely mapped. Normally a cutoff of 20-30bp is standard.</p>
<p>Trim with caution and think about the consequences of having different length reads later on in your pipeline. In fact, it is possible to overtrim your reads and aggressively remove valid data.</p>
<p><br></p>
</section>
<section id="cutadapt" class="level3">
<h3 class="anchored" data-anchor-id="cutadapt">Cutadapt</h3>
<p><a href="http://cutadapt.readthedocs.org/en/stable/index.html">Cutadapt</a> finds and removes unwanted sequences from your high-throughput sequencing reads. Cutadapt can perform quality trimming, adapter removal and read filtering as well as many other operations to prepare your reads for optimal alignment. We will run cutadapt with the following parameters:</p>
<ul>
<li>-a : The sequence of the adapter to remove</li>
<li>-q : Trim reads from the 3’ end with the given quality threshold (Phred score)</li>
<li>–minimum-length : Filter out reads below this length</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> samples.txt <span class="kw">|</span> <span class="ex">parallel</span> <span class="at">-j</span> 4 <span class="st">"cutadapt -a AGATCGGAAGAG -q 20 --minimum-length 36 -o fastq/{}.trim.fq.gz fastq/{}.fq.gz &gt; fastq/{}.trim.cutadapt_report.txt"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We will also run FastQC on the trimmed dataset.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> samples.txt <span class="kw">|</span> <span class="ex">parallel</span> <span class="at">-j</span> 4 fastqc fastq/{}.trim.fq.gz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To view a cutadapt report:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">less</span> fastq/Reb1_R1.trim.cutadapt_report.txt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>hit ‘q’ to exit less.</p>
<p>Let’s compare the fastqc reports using <a href="http://multiqc.info/">multiqc</a>. As you have run it already you need to use the force (-f) flag to get it to overwrite the current report.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">multiqc</span> <span class="at">-f</span> <span class="at">-o</span> fastq fastq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Open the multiqc report via a web browser to see how the raw and trimmed datasets compare.</p>
<p><br></p>
</section>
<section id="other-qc-software-worth-investigating" class="level3">
<h3 class="anchored">Other QC software worth investigating</h3>
<ul>
<li><a href="http://www.usadellab.org/cms/?page=trimmomatic">Trimmomatic</a> is very good and runs with Java</li>
<li><a href="http://www.bioinformatics.babraham.ac.uk/projects/trim_galore/">Trim Galore!</a></li>
</ul>
<div class="key-points">
<h2 class="anchored" data-anchor-id="other-qc-software-worth-investigating">
<i class="fas fa-thumbtack"></i>Key Aims:
</h2>
<ul>
<li>Understand the Fastq format</li>
<li>Check for contaminants</li>
<li>Assess sequence quality</li>
<li>Understand parallel</li>
<li>Trim your data</li>
</ul>
</div>
<p><br></p>
</section>
</section>
<section id="mapping-and-filtering" class="level2">
<h2 class="anchored" data-anchor-id="mapping-and-filtering">3. Mapping and Filtering</h2>
<section id="read-alignment" class="level3">
<h3 class="anchored" data-anchor-id="read-alignment">Read Alignment</h3>
<p>In this workshop we are going to align our ChIP-seq reads to the yeast reference genome. There are many tools available for mapping reads each with their own purposes and strengths. We are going to use <a href="http://bio-bwa.sourceforge.net/bwa.shtml">BWA</a> as it is suitable for aligning single end short ChIP-seq reads and has a reasonable balance of accuracy and speed.</p>
<p><br></p>
</section>
<section id="genome-assemblies-and-indexing" class="level3">
<h3 class="anchored" data-anchor-id="genome-assemblies-and-indexing">Genome assemblies and indexing</h3>
<p>First, we need to select a reference genome to align to. Every time a reference genome is released or updated it is given a new name, often referred to as the genome build or assembly (..hg18, hg19, hg38). It is important to realise that different builds of the same genome are different sequences and thus their co-ordinate sytems are incompatable. For instance position 10000000 on chr1 is T in hg19 and G in hg38.</p>
<p>We are going to map our reads to the latest release of the yeast genome <strong>sacCer3</strong>. We need to create an index file from the sacCer3 sequence so that BWA can quickly access the reference sequences. Luckily many of these indexes are pre-computed on our servers and stored under the ~genomes directory so you would only need to run this step for a new genome:</p>
<div class="blue">
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># do not run</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#bwa index -p /home/genomes/s.cerevisiae/sacCer3/bwa_indexes/sacCer3 -a is /home/genomes/s.cerevisiae/sacCer3/sacCer3.fa</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
</section>
<section id="mapping-reads-with-bwa" class="level3">
<h3 class="anchored" data-anchor-id="mapping-reads-with-bwa">Mapping reads with BWA</h3>
<p>Once we have an index we can align our reads to the sacCer3 genome with BWA. This will take ~5 minutes to run so let’s get it started:</p>
<p>First create a new directory for the alignments and sub directories for each sample to keep your data organsied:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> bwa_out</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> samples.txt <span class="kw">|</span> <span class="ex">parallel</span> <span class="at">-j</span> 4 mkdir bwa_out/{}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then run bwa on each of your samples. Note that we are redirecting the output to a file using <strong>&gt;</strong> so we put the full command in quotes for parallel to execute.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> samples.txt <span class="kw">|</span> <span class="ex">parallel</span> <span class="at">-j</span> 4 <span class="st">"bwa mem -t 5 -a -R '@RG\tID:{}\tPL:ILLUMINA' -M /home/genomes/s.cerevisiae/sacCer3/bwa_indexes/sacCer3 fastq/{}.trim.fq.gz &gt; bwa_out/{}/{}.sam"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<p>This will take slightly longer to run. <!--This is a good time to go make a **coffee**! --></p>
<p><br></p>
</section>
<section id="sambamcram-format-and-samtools" class="level3">
<h3 class="anchored">SAM/BAM/CRAM format and Samtools</h3>
<p>The standard output for most mapping software is SAM (sequence alignment/map format). SAM files contain many columns that describe the position of each alignment as well as information on the quality of the alignment, mismatches, the number of times a read mapped, mapping of paired ends and other custom flags and statistics. SAM files can be very large so there are compressed alternatives BAM and CRAM. The <a href="http://www.htslib.org/doc/samtools.html">samtools</a> package has many useful tools for viewing and manipulating files in SAM format. We will use some of these below.</p>
<p>Take a look at the <a href="https://samtools.github.io/hts-specs/SAMv1.pdf">SAM format specification</a> and the first few lines of your SAM output using samtools:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view bwa_out/Reb1_R1/Reb1_R1.sam <span class="kw">|</span> <span class="fu">less</span> </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The second column is the <strong>SAM flag</strong> and contains coded information about each alignment. Use the <a href="https://broadinstitute.github.io/picard/explain-flags.html">Explain SAM flags</a> resource to find out more about the alignments in your file.</p>
<p>We can also see the samtools header using the -h flag which contains information on the parameters and indexes used to create the file.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-h</span> bwa_out/Reb1_R1/Reb1_R1.sam <span class="kw">|</span> <span class="fu">less</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We can use samtools to sort the sam file by co-ordinate and output in the binary format BAM to save disk space. The BAM file can also be indexed to allow quick programmatic access for visualisation and processing. We can feed multiple commands into our call to parallel by separating them with a semi colon <strong>;</strong>.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> samples.txt <span class="kw">|</span> <span class="ex">parallel</span> <span class="at">-j</span> 4 <span class="st">"samtools sort bwa_out/{}/{}.sam -o bwa_out/{}/{}.bam -T bwa_out/{}/{} -O BAM; samtools index bwa_out/{}/{}.bam"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Take a look at the contents of the <em>bwa_out</em> directory now. The -lh flag prints out a directory in list view with human readable file sizes.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-lh</span> bwa_out/<span class="pp">*</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Notice the difference in size between the SAM and BAM files and the .bai file which is the bam index. Let’s look at one of the BAM files using <code>samtools idxstats</code> to see where our reads align</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> idxstats bwa_out/Reb1_R1/Reb1_R1.bam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The third column represents the number of alignments to each chromosome and at the bottom we can see some reads which have not mapped at all.</p>
<div class="key-points">
<h2 class="anchored" data-anchor-id="sambamcram-format-and-samtools">
<i class="fas fa-thumbtack"></i> Key points:
</h2>
<ul>
<li>Align reads to a reference genome</li>
<li>Understand alignment file formats</li>
</ul>
</div>
<p><br></p>
</section>
</section>
<section id="post-processing" class="level2">
<h2 class="anchored" data-anchor-id="post-processing">4. Post Processing</h2>
<p><br></p>
<section id="filtering-reads-with-samtools" class="level3">
<h3 class="anchored" data-anchor-id="filtering-reads-with-samtools">Filtering reads with samtools</h3>
<p>Now that we have aligned our reads we may want to do some filtering before any downstream analysis. Make sure you are aware of the alignments that are reported by your mapping program and the parameters used. For instance, are unmapped reads reported? Are all alignments to repeats reported or just one? Are paired-end alignments still reported if only one end maps?</p>
<p>There are many ways to filter your BAM files with samtools and other programs to remove unwanted alignments that may negatively affect your downstream analysis. This will not be covered in depth here, instead we will simply remove all non-uniquely mapped reads. These reads map to multiple regions of the genome and can skew classification of peaks in our data. In this case we are not interested in looking at repeat regions of the genome so we will remove these reads. This can be done by filtering out all reads with <a href="http://genome.sph.umich.edu/wiki/Mapping_Quality_Scores">mapping quality</a> less than 20.</p>
<p><br></p>
</section>
<section id="multimap-reads-and-duplicate-reads" class="level3">
<h3 class="anchored" data-anchor-id="multimap-reads-and-duplicate-reads">Multimap reads and Duplicate reads</h3>
<p>Multimap and duplicate reads are often confused so it is important to understand what these are and how they affect your data:</p>
<ul>
<li><strong>Multimap reads</strong> = The read exists once in your library and aligns to multiple repeat locations in the reference genome</li>
<li><strong>Duplicate reads</strong> = Multiple reads with the same sequence align to identical locations in the genome.</li>
</ul>
<p><img src="images/multi.png" alt="pic" width="600"></p>
<p><strong>Multimap reads</strong> are difficult to analyse as their ambiguity can confound results. Many applications require the use of <strong>unique</strong> alignments only, thus multimap reads need to be removed from your BAM file. Aligners assign a <strong>mapping quality</strong> to each read (column 5 in BAM) between 0 and 255 that describes its confidence in the alignment position. Assigned <a href="https://sequencing.qcfail.com/articles/mapq-values-are-really-useful-but-their-implementation-is-a-mess/">mapping qualities differ between mappers</a> and BWA uses a phred score to measure the accuracy of an alignment. Filtering out reads with a mapping quality &lt; 20 means that all remaining alignment positions are 99% accurate. We can use <code>samtools view -q</code> to filter based on mapping quality</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> samples.txt <span class="kw">|</span> <span class="ex">parallel</span> <span class="at">-j</span> 4 <span class="st">"samtools view -b -q 20 bwa_out/{}/{}.bam -o bwa_out/{}/{}.uniq.bam; samtools index bwa_out/{}/{}.uniq.bam"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note that there are aligners and analysis packages that attempt to deal with multimap reads and assign weights to each alignment, although methods are still in development. If you are interested in repeat elements or don’t want to discard any potentially useful information then you will need a strategy to deal with these reads.</p>
<p><strong>Duplicate reads</strong> are often observed as tall spikes in your read depth profile where reads are stacked directly on top of each other. A high level of duplication in your library is often a sign of over amplification by PCR and we may want to remove this bias from our result. However, these reads may also derive from separate fragments of DNA in your sample, thus we would be removing real data. It is often a good idea to <strong>mark</strong> your duplicate reads and produce outputs both with and without duplicates for comparison. Read more about duplication bias <a href="https://sequencing.qcfail.com/articles/libraries-can-contain-technical-duplication/">here</a>.</p>
<p>The <a href="https://broadinstitute.github.io/picard/index.html">Picard</a> package has many useful utilities for manipulating SAM/BAM files. The MarkDuplicates tool will check the alignment positions for duplicate reads and mark or remove them from your data depending on how you wish to treat them.</p>
<p>Using paired-end reads or random primers in your library preparation can help separate some of the original reads from PCR duplicates.</p>
<p><br></p>
</section>
<section id="genome-blacklists" class="level3">
<h3 class="anchored" data-anchor-id="genome-blacklists">Genome blacklists</h3>
<p>The ENCODE project produced 100s of NGS datasets and found that certain regions of the genome were consistently prone to overinflated read depths regardless of the sample or preparation. Some of these are repeats of variable copy number, others are likely to be similar to <a href="https://sequencing.qcfail.com/articles/genomic-sequence-not-in-the-genome-assembly-creates-mapping-artefacts/">repeat regions in unsequenced portions of the genome</a> (telomeres, centromeres, satellites etc.). These are typically seen as large towers of reads that dominate your read profiles. It is probably a good idea to remove these regions from downstream analyses or remove the reads that align all together. ENCODE subsequently released genome blacklists for human and mouse, for other species you can identify these regions by eye.</p>
<p><a href="http://bedtools.readthedocs.org/en/latest/">BedTools</a> is an extremely useful tool suite for performing operations on genomic intervals and alignments and comparing multiple datasets. The intersect tool can find overlaps between reads in a BAM file <code>-abam</code> and blacklist regions in a <a href="https://genome.ucsc.edu/FAQ/FAQformat.html#format1">bed</a> file <code>-b</code> and output all the reads that DON’T intersect <code>-v</code>.</p>
<p><img src="images/intersect-glyph.png" width="700"></p>
<p>In some cases you may also want to remove ribosomal RNA/DNA reads that make up a bulk of your sample.</p>
<p><br></p>
</section>
<section id="how-many-reads" class="level3">
<h3 class="anchored">How many reads?</h3>
<p>As we used the -a flag when aligning <strong>bwa</strong> outputs multiple alignments per read if they exist, meaning a read may have many entries within a BAM file. However, bwa will assign one of the best hits as a primary alignment and all the others as secondary. Unmapped reads are also printed to the output file and these two factors mean that the total number of lines does not correspond to the total number of mapped reads.</p>
<p><code>samtools view</code> can tell us how many reads are in a bam file using the -c flag to count.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-c</span> bwa_out/Reb1_R1/Reb1_R1.bam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Reb1_R1.bam: 5444557</p>
<p>We can filter alignments using -f (keep) or -F (discard) on the SAM flag column.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># counts number of unmapped reads (flag = '4')</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-c</span> <span class="at">-f</span> 4 bwa_out/Reb1_R1/Reb1_R1.bam </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>144915 are unmapped in total (we saw this with idxstats already).</p>
<p><br></p>
<div class="challenge">
<h2 class="anchored" data-anchor-id="how-many-reads">
<i class="fas fa-pencil-alt"></i> Challenge:
</h2>
<ul>
<li>How many <em>mapped</em> reads do you have in Reb1_R1?</li>
<li>How many of these align to a single (primary) location on the genome?</li>
<li>How many have a MAPQ score above 20?</li>
</ul>
<details>
<summary>
Solution
</summary>
<div class="solution proof">
<p><span class="proof-title"><em>Solution</em>. </span></p>
<h2 class="anchored">
<i class="far fa-eye"></i>
</h2>
<p>Here ‘-F 4’ filters out unmapped reads</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-c</span> <span class="at">-F</span> 4 bwa_out/Reb1_R1/Reb1_R1.bam </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Reb1_R1 has 5299642 mapped reads</p>
<p>We can combine flags</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-c</span> <span class="at">-F</span> 260 bwa_out/Reb1_R1/Reb1_R1.bam</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -F 260 filters out unmapped reads (4) and non primary alignments (256)</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># This gets same result </span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-c</span> <span class="at">-F</span> 256 <span class="at">-F</span> 4 bwa_out/Reb1_R1/Reb1_R1.bam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>2572126 reads map to a single ‘unique’ location</p>
<p>We can either count the reads using -q 20 as we used earlier or just count our uniq.bam file</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-c</span> <span class="at">-q</span> 20 bwa_out/Reb1_R1/Reb1_R1.bam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>1967026 reads have a MAPQ &gt; 20</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">samtools</span> view <span class="at">-c</span> bwa_out/Reb1_R1/Reb1_R1.uniq.bam</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Reb1_R1.uniq.bam: 1967026</p>
<p>Note our filtered uniq.bams have excluded unmapped/non primary reads by filtering by MAPQ &lt; 20</p>
</div>
</details>
</div>
<p><br> <strong>Hint:</strong> Use the <a href="https://broadinstitute.github.io/picard/explain-flags.html">Explain SAM flags</a> resource.</p>
<p>We can also use <strong>fastqc</strong> on bam files to look at the quality and statistics for our uniquely mapped reads.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> samples.txt <span class="kw">|</span> <span class="ex">parallel</span> <span class="at">-j</span> 4 fastqc bwa_out/{}/{}.uniq.bam</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="ex">multiqc</span> <span class="at">-o</span> bwa_out bwa_out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="key-points">
<h2 class="anchored">
<i class="fas fa-thumbtack"></i>Key Aims:
</h2>
<ul>
<li>Understand read types</li>
<li>Filter alignments for further analyses</li>
</ul>
</div>
<p><br></p>
</section>
</section>
<section id="visualisation" class="level2">
<h2 class="anchored" data-anchor-id="visualisation">5. Visualisation</h2>
<section id="converting-bam-files-to-bigwig-tracks" class="level3">
<h3 class="anchored" data-anchor-id="converting-bam-files-to-bigwig-tracks">Converting BAM files to bigWig tracks</h3>
<p>Visually inspecting data via a genome browser is often the first step in any analysis. Has the sequencing worked as expected? Are there noticeable differences between my samples by eye? BAM files are typically large and contain detailed information for every read, thus they are slow to access and view on a genome browser. If we are only interested in read profiles we can convert our BAM files to graphs of sequencing depth per base. The <strong>wiggle</strong> file format has three columns to represent a genomic interval and a 4th as a score which will represent the number of reads overlapping that region. We will create a compressed version of this format called <strong>bigWig</strong> for use with genome browsers. To do this we are going to use the <a href="https://deeptools.readthedocs.io">deepTools</a> package which has a lot of useful tools particularly for ChIP-seq analysis.</p>
<p>The <a href="https://deeptools.readthedocs.io/en/develop/content/tools/bamCoverage.html">bamCoverage</a> tool in deepTools has many different options for normalising, smoothing and filtering your BAM files before converting to bigWig and the documentation is worth a read.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> samples.txt <span class="kw">|</span> <span class="ex">parallel</span> <span class="at">-j</span> 4 <span class="st">"bamCoverage -bs 1 --normalizeUsing BPM -e 200 -b bwa_out/{}/{}.uniq.bam --outFileName bwa_out/{}/{}.uniq.bw"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>-bs</strong> is the bin size. We set this to 1, but we could smooth our read coverage into larger bins across the genome.</li>
<li><strong>–normalizeUsing BPM</strong> is a normalisation strategy akin to TPM in RNA-seq and stands for “bins per million”. There are several strategies to choose or we can ignore normalisation.</li>
<li><strong>-e 200</strong> extends our reads to 200b as this is the average fragment length. With paired end data the reads would be extended to match the ends of both reads but with single end we must supply a value.</li>
</ul>
<p><br></p>
</section>
<section id="integrative-genomics-viewer-igv" class="level3">
<h3 class="anchored">Integrative Genomics Viewer (IGV)</h3>
<p><a href="https://www.broadinstitute.org/igv/">IGV</a> (Integrative genomics viewer) is a powerful genome browser from the Broad institute. It is perfect for viewing your sequencing files as loading data is easy, common formats are understood, views are customisable and navigation is quick.</p>
<p>First let’s put all of our visualisation files in one folder.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> visualisation</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-s</span> <span class="va">$PWD</span>/bwa_out/<span class="pp">*</span>/<span class="pp">*</span>bw visualisation</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-s</span> <span class="va">$PWD</span>/bwa_out/<span class="pp">*</span>/<span class="pp">*</span>uniq.bam<span class="pp">*</span> visualisation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It is best to download the <a href="https://www.broadinstitute.org/igv/">desktop app</a> for use on your own machine but if you are using a university managed computer you can access the web app at <a href="https://igv.org/app/" class="uri">https://igv.org/app/</a>.</p>
<p>Open IGV and first set the genome to <strong>sacCer3</strong>, then find your <em>visualisation</em> folder online. In the desktop version you can drag and drop files into IGV. If you are using the webapp you will need to download the files you require and open them using the <em>tracks</em> menu.</p>
<p>Open a BAM file and a corresponding bigWig file into IGV. Make sure the .bai index file is in the same folder as the BAM.</p>
<p>To load a BAM file via URL;</p>
<p>From you visualisation page right click and ‘copy link’</p>
<p>In IGV go to File / Load from URL / Paste URL into box</p>
<p>e.g.&nbsp;https://bifx-core3.bio.ed.ac.uk/~USER/ChIP-seq_workshop/visualisation/Reb1_R1.uniq.bam</p>
<p><img src="images/igv_w_bam.png" width="1200"></p>
<p>First, let’s navigate the chromosome:</p>
<ul>
<li>Use the <em>+</em> / <em>-</em> zoom bar at the top right</li>
<li>Drag and highlight an area to zoom on the genome ruler</li>
<li>Type a position or gene identifier in to the search box</li>
<li>If we <strong>zoom in</strong> close enough our BAM file will load and we can investigate alignments of individual reads</li>
</ul>
<p>Now let’s customise our view:</p>
<p>DESKTOP APP</p>
<ol type="1">
<li>Select <strong>Tracks-&gt;Fit Data To Window</strong> To automatically set track heights to fill the view</li>
<li>Right click on the Refseq genes track and switch between display modes <strong>Collapsed</strong>, <strong>Expanded</strong> and <strong>Squished</strong>. (Use the horizontal panel divider to adjust height)</li>
<li>Use the right click menu on the bigwig track name to customise the display. Try the following:</li>
<li>Rename the track</li>
<li>Change the track colour</li>
<li>Change the graph type</li>
<li>Change the windowing function</li>
<li>Adjust the data range</li>
<li>Set the scale to <strong>Autoscale</strong>. This automatically sets the Y-axis to the height of the tallest peak in your view.</li>
</ol>
<p>WEB APP</p>
<ol type="1">
<li>Use the cog on the Ensembl genes track to switch between display modes <strong>Collapsed</strong>, <strong>Expanded</strong> and <strong>Squished</strong>.</li>
<li>Customise the bigwig track by trying the following:</li>
<li>Rename the track</li>
<li>Change the track colour</li>
<li>Change the track height</li>
<li>Set a minimum and maximum Y-axis</li>
<li>Set the scale to <strong>Autoscale</strong>. This automatically sets the Y-axis to the height of the tallest peak in your view.</li>
</ol>
<p><br></p>
<div class="discussion">
<h2 class="anchored" data-anchor-id="integrative-genomics-viewer-igv">
<i class="fas fa-pencil-alt"></i> Discussion:
</h2>
<ul>
<li><p>Why are the coverage profiles different?</p></li>
<li><p>Which format is faster to view?</p></li>
<li><p>Can you identify <strong>mismatches</strong> in read alignment?</p></li>
<li><p>What other information do the BAM files give us?</p></li>
</ul>
</div>
<p>Now let’s load all our bigwig files (when comparing multiple samples it is useful to use group autoscale), have a look around the genome.</p>
<p><img src="images/igv_bw_auto.png" width="1200"></p>
<p><br></p>
<div class="discussion">
<ul>
<li><p>Can you identify any potential peaks in the ChIP samples</p></li>
<li><p>Do you see any peaks that are also present in the Input?</p></li>
<li><p>Are there any potential (blacklist) regions you might consider filtering?</p></li>
</ul>
</div>
<p><br></p>
</section>
<section id="other-genome-browsers" class="level3">
<h3 class="anchored" data-anchor-id="other-genome-browsers">Other genome browsers</h3>
<ul>
<li><a href="http://www.ensembl.org">Ensembl</a> and <a href="https://genome.ucsc.edu/">UCSC</a> websites have online genome browsers where you can view your data alongside published experimental data and genomic annotations in their databases.</li>
</ul>
<p><br></p>
</section>
<section id="tidy-up" class="level3">
<h3 class="anchored">Tidy Up!</h3>
<p>Files are large, disk space is expensive, remove any unwanted or temporary files from your folder. We should always keep the raw data (fastq) and our final processed datasets (BAM, bigWig etc) and the script we used to generate them. SAM files are large and should be removed once converted to BAM.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> fastq/<span class="pp">*</span>trim<span class="pp">*</span>fq.gz <span class="co">#Remove trimmed fastq temp files</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> bwa_out/<span class="pp">*</span>/<span class="pp">*</span>.sam <span class="co">#Remove sam files</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<div class="key-points">
<h2 class="anchored" data-anchor-id="tidy-up">
<i class="fas fa-thumbtack"></i>Key Aims:
</h2>
<ul>
<li>Create tracks from our data</li>
<li>Visualise alignments on a genome browser</li>
</ul>
</div>
<p><br></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->



</body></html>