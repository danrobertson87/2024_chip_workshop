<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Analysing High Throughput Sequencing Data - Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./images/logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Analysing High Throughput Sequencing Data</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./ChIP-seq_workshop_processing.html">
 <span class="menu-text">Processing</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./ChIP-seq_workshop_analysis.html" aria-current="page">
 <span class="menu-text">Analysis</span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#assessing-chip-quality" id="toc-assessing-chip-quality" class="nav-link active" data-scroll-target="#assessing-chip-quality">1. Assessing ChIP quality</a>
  <ul class="collapse">
  <li><a href="#correlation-amongst-samples" id="toc-correlation-amongst-samples" class="nav-link" data-scroll-target="#correlation-amongst-samples">Correlation amongst samples</a></li>
  <li><a href="#assessing-signal-strength" id="toc-assessing-signal-strength" class="nav-link" data-scroll-target="#assessing-signal-strength">Assessing signal strength</a></li>
  <li><a href="#summarizing-chip-signal-enrichment-across-genes" id="toc-summarizing-chip-signal-enrichment-across-genes" class="nav-link" data-scroll-target="#summarizing-chip-signal-enrichment-across-genes">Summarizing ChIP signal enrichment across genes</a></li>
  </ul></li>
  <li><a href="#calling-peaks" id="toc-calling-peaks" class="nav-link" data-scroll-target="#calling-peaks">2. Calling peaks</a>
  <ul class="collapse">
  <li><a href="#macs2" id="toc-macs2" class="nav-link" data-scroll-target="#macs2">MACS2</a></li>
  <li><a href="#finding-peaks-with-macs" id="toc-finding-peaks-with-macs" class="nav-link" data-scroll-target="#finding-peaks-with-macs">Finding peaks with MACS</a></li>
  <li><a href="#inspecting-peaks" id="toc-inspecting-peaks" class="nav-link" data-scroll-target="#inspecting-peaks">Inspecting Peaks</a></li>
  <li><a href="#what-sequence-motifs-are-found-within-peaks" id="toc-what-sequence-motifs-are-found-within-peaks" class="nav-link" data-scroll-target="#what-sequence-motifs-are-found-within-peaks">What sequence motifs are found within peaks?</a></li>
  </ul></li>
  <li><a href="#scripting" id="toc-scripting" class="nav-link" data-scroll-target="#scripting">3. Scripting</a>
  <ul class="collapse">
  <li><a href="#tidy-up" id="toc-tidy-up" class="nav-link" data-scroll-target="#tidy-up">Tidy Up!</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Analysis</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>


<script src="https://kit.fontawesome.com/ece750edd7.js" crossorigin="anonymous"></script>

<!--
::: key-points
<h2><i class="fas fa-thumbtack"></i> Key points:</h2>

-   test
:::

::: discussion
<h2><i class="far fa-bell"></i> Discussion</h2>

-   test
:::

::: resources
<h2><i class="fas fa-book"></i> Further Learning</h2>

test
:::

::: challenge
<h2><i class="fas fa-pencil-alt"></i> Challenge:</h2>

test
:::

-->
<div class="objectives">
<h2 class="anchored">
<i class="far fa-check-square"></i> Learning Objectives
</h2>
<ul>
<li><p>Assess the quality of ChIP-Seq experiment</p></li>
<li><p>Call peaks in data</p></li>
<li><p>Understand scripting</p></li>
</ul>
</div>
<section id="assessing-chip-quality" class="level2">
<h2 class="anchored" data-anchor-id="assessing-chip-quality">1. Assessing ChIP quality</h2>
<p>After we have mapped and filtered the reads it is time to make some inferences about how good the underlying data is.</p>
<p><br></p>
<section id="correlation-amongst-samples" class="level3">
<h3 class="anchored" data-anchor-id="correlation-amongst-samples">Correlation amongst samples</h3>
<p>In our experiment there are two replicates, each containing treatment and input (control) datasets. The first thing we can check is if the samples are correlated (in other words if treatment and control samples across the two replicates contain this same kind of signal). To do this we first generate a read count matrix using <a href="https://deeptools.readthedocs.io/en/develop/content/tools/multiBamSummary.html">deepTools multiBamSummary</a>. It will take around 5 minutes to complete so it’s best to set it running and read on.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">multiBamSummary</span> bins <span class="at">-b</span> bwa_out/<span class="pp">*</span>/<span class="pp">*</span>uniq.bam <span class="at">-bs</span> 10000 <span class="at">-o</span> cov.matrix <span class="at">-e</span> 200 <span class="at">--smartLabels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This tool splits the genome into bins of fixed size (10,000 bp in our example) and computes the number of reads falling within each bin. The output is in a compressed unreadable format but here is a fragment of the data produced:</p>
<pre><code>#'chr' 'start' 'end'  'Reb1_R1'  'Input_R1'  'Input_R1'  'Reb1_R2'
chrVI      0     10000   19.0         41.0         3.0        6.0
chrVI   10000    20000   29.0         30.0        13.0        5.0
chrVI   20000    30000    0.0          0.0         0.0        0.0
chrVI   30000    40000    0.0          2.0         0.0        0.0
chrVI   40000    50000 7447.0        139.0         7.0     2645.0</code></pre>
<p>We can then feed this matrix into <strong>DeepTools plotCorrelation</strong> to generate a heat map.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">plotCorrelation</span> <span class="at">-in</span> cov.matrix <span class="at">-p</span> heatmap <span class="at">-c</span> spearman <span class="at">-o</span> spearman_cor.png</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="images/spearman_cor.png" width="700"></p>
<p>Here we can see that treatments (Reb1) and controls (input) correlate well with each other, while correlation between treatments and controls is weak. This is a good sign implying that there is reproducible signal on our data.</p>
<p><br></p>
</section>
<section id="assessing-signal-strength" class="level3">
<h3 class="anchored" data-anchor-id="assessing-signal-strength">Assessing signal strength</h3>
<p>How do we tell if we have signal coming from ChIP enrichment? One way of doing this is Signal Extraction Scaling (SES) proposed by <a href="https://www.degruyter.com/downloadpdf/j/sagmb.2012.11.issue-3/1544-6115.1750/1544-6115.1750.pdf">Diaz:2012</a>. SES works as follows: Suppose we have two datasets: ChIP and Input DNA. We divide the genome into N non-overlapping windows and for each window we compute the number of reads in each sample. We then sort the windows by the number of reads in 1 sample and plot the cumulative fraction of reads. We expect Input samples to show approximately equal distribution of reads across all windows and thus give a flat line, whereas ChIP samples with very defined enrichments should have a high proportion of reads in a small number of bins. <a href="http://deeptools.readthedocs.io/en/latest/">DeepTools</a> provides a nice explanation of how the success of a ChIP experiment can be judged based on SES (also called fingerprint) plots:</p>
<p><img src="images/dt_fingerhelp.png" width="700"></p>
<p>We can apply this to our own data with <strong>DeepTools plotFingerprint</strong>:</p>
<div class="blue">
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># very slow</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">plotFingerprint</span> <span class="at">-b</span> bwa_out/<span class="pp">*</span>/<span class="pp">*</span>uniq.bam <span class="at">-e</span> 200 <span class="at">--smartLabels</span> <span class="at">-o</span> fingerprint.png <span class="kw">&amp;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The fingerprint tool can take a long time to run so we will run in the background (&amp;) and continue with the tutorial. However, You should get a plot that looks like the one below where approximately 30% of the ChIP reads are concentrated in to a small number of bins.</p>
<p><img src="images/dt_fingerplot.png" width="700"></p>
<p><br></p>
</section>
<section id="summarizing-chip-signal-enrichment-across-genes" class="level3">
<h3 class="anchored">Summarizing ChIP signal enrichment across genes</h3>
<p>How many genes contain upstream regions enriched in Reb1 ChIP-seq reads? This is often represented as a heatmap, here is an example of histone modification ChIP-seq data from the Deeptools documentation:</p>
<p><img src="images/plotHeatmap_example.png" width="700"></p>
<p>First we want to create normalised datasets of ChIP signal vs Input for our two replicates. This is done using <strong>DeepTools bamCompare</strong> and gives us a bigWig file of normalised log2 ratios.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bamCompare</span> <span class="at">-b1</span> bwa_out/Reb1_R1/Reb1_R1.uniq.bam <span class="at">-b2</span> bwa_out/Input_R1/Input_R1.uniq.bam <span class="at">-o</span> Reb1_R1.norm.bw <span class="at">-e</span> 200 <span class="at">--operation</span> log2 <span class="at">--normalizeUsing</span> BPM <span class="at">--scaleFactorsMethod</span> None <span class="kw">&amp;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">bamCompare</span> <span class="at">-b1</span> bwa_out/Reb1_R2/Reb1_R2.uniq.bam <span class="at">-b2</span> bwa_out/Input_R2/Input_R2.uniq.bam <span class="at">-o</span> Reb1_R2.norm.bw <span class="at">-e</span> 200 <span class="at">--operation</span> log2 <span class="at">--normalizeUsing</span> BPM <span class="at">--scaleFactorsMethod</span> None <span class="kw">&amp;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The bamCompare tool should take ~5 minutes to complete so you can move on to the next step. These bigWig files can also be viewed in IGV so go ahead and link them to the visualisation folder:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-s</span> <span class="va">$PWD</span>/<span class="pp">*</span>norm.bw visualisation</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Because we want to plot enrichment around genes we need the gene annotations. These are already downloaded in the ~genomes folder so let’s link them to our current directory.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /homes/genomes/s.cerevisiae/sacCer3/annotation/UCSC_sgdGene.bed .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Take a look at this file:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span> UCSC_sgdGene.bed</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>These gene annotations are downloaded from the UCSC website in bed12 format: The co-ordinates are in columns 1-3, the gene name in column 4 and the strand in column 6.</p>
<p>To prepare data necessary for drawing the heatmap we will use <a href="https://deeptools.readthedocs.io/en/develop/content/tools/computeMatrix.html">deepTools computeMatrix</a>. Here we supply our normalised datasets as (S)core files along with the yeast genes from UCSC as the (R)egions to plot. We are going to compute reads around the TSS in 100b bins, with a 2kb flanking region either side.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">computeMatrix</span> reference-point <span class="at">-R</span> UCSC_sgdGene.bed <span class="at">-S</span> Reb1_R1.norm.bw Reb1_R2.norm.bw <span class="at">-o</span> TSS.matrix <span class="at">--referencePoint</span> TSS <span class="at">--upstream</span> 2000 <span class="at">--downstream</span> 2000 <span class="at">-bs</span> 100 <span class="at">--smartLabels</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The warning “Skipping Q0010, due to being absent in the computeMatrix output.” refers to mitochondrial genes and chrM has been exlcuded.</p>
<p>Finally, we can visualize the heatmap by using the <strong>DeepTools plotHeatmap</strong> tool:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">plotHeatmap</span> <span class="at">-m</span> TSS.matrix <span class="at">-o</span> TSS.heatmap.png </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The resulting image shows that a significant fraction of genes have peaks of Reb1 enrichment within their upstream regions:</p>
<details>
<summary>
Reveal Plot
</summary>
<div class="solution proof">
<p><span class="proof-title"><em>Solution</em>. </span></p>
<h2 class="anchored" data-anchor-id="summarizing-chip-signal-enrichment-across-genes">
<i class="far fa-eye"></i>
</h2>
<p><img src="images/TSS.heatmap.png" width="700"></p>
</div>
</details>
<p>It is worth taking a look at the <a href="http://deeptools.readthedocs.io/en/latest/content/list_of_tools.html">documentation</a> for the deepTools package in your own time to understand the range of tools and how different parameters affect your data and the different plots you can make.</p>
<p><br></p>
</section>
</section>
<section id="calling-peaks" class="level2">
<h2 class="anchored" data-anchor-id="calling-peaks">2. Calling peaks</h2>
<p>While the peaks we have found in the genome browser are pretty clear and consistent across the two replicates, looking at the entire genome in the browser is hardly an efficient way to identify all peaks of Reb1 binding. There are several ways to identify genome-wide binding events and three of these methods are summarised below:</p>
<p><img src="images/peak_finding.jpg" width="700"></p>
<p><br></p>
<section id="macs2" class="level3">
<h3 class="anchored" data-anchor-id="macs2">MACS2</h3>
<p>In this tutorial we will use the program <a href="https://github.com/taoliu/MACS">MACS2</a>. MACS2 performs several steps for calling peaks from paired treatment/control datasets:</p>
<p><img src="images/macs_meth.jpg" width="400"></p>
<p>Here is a concise description of these steps:</p>
<ul>
<li><strong>Removing redundancy</strong> - MACS retains uniquely mapped reads and removes reads that are repeatedly mapped to the same location. This reduces effects of PCR amplification biases during library preparation.</li>
<li><strong>Build model and estimate fragment size</strong> - one of the MACS inputs is the fragment size or bandwidth, which is approximate size of DNA fragments generated during fragmentation step of library preparation. MACS first slides a window sized at twice the bandwidth across the genome and finds instances where read counts enriched by between 10 and 30 fold relative to the genome background. It then randomly samples 1,000 of such regions and builds the model. To build the model it separates reads mapping to each of the strands and builds two distributions (two modes). The midpoint between the two modes is the middle of the binding size and the distance between the modes is the fragment size d (see Figure below).</li>
<li><strong>Generate peaks</strong> - now that d has been defined MACS slides a window of size 2d across the genome to identify regions significantly enriched in the ChIP sample. MACS assumes that background reads obey <a href="https://en.wikipedia.org/wiki/Poisson_distribution">Poisson distribution</a>. Thus given the number of reads in a given interval within the control sample we can calculate the probability of having observed number of reads in the ChIP sample (e.g., see flood example <a href="https://en.wikipedia.org/wiki/Poisson_distribution#Examples_of_probability_for_Poisson_distributions">here</a>). This procedure is performed for several intervals around the examined location (2d, 1kb, 5kb, 10kb, and the whole genome) and the maximum value is chosen. One problem with this approach is that it only works if both samples (ChIP and control) are sequenced to the same depth, which is not usually happening in practice. To correct this MACS scales down the larger sample.</li>
<li><strong>Compute False Discovery Rate (FDR)</strong> - <a href="http://www.nature.com/nprot/journal/v7/n9/full/nprot.2012.101.html">Feng:2012</a> explains computing FDR in MACS as follows: “When a control sample is available (and you should really always use it), MACS can also estimate an empirical FDR for every peak by exchanging the ChIP-seq and control samples and identifying peaks in the control sample using the same set of parameters used for the ChIP-seq sample. Because the control sample should not exhibit read enrichment, any such peaks found by MACS can be regarded as false positives. For a particular P value threshold, the empirical FDR is then calculated as the number of control peaks passing the threshold divided by the number of ChIP-seq peaks passing the same threshold.”</li>
</ul>
<p><img src="images/macs_peak.png" width="500"></p>
<p>Peaks mapped to two strands are treated separately to build two coverage density profiles - two modes. The distance between the modes is the fragment size d.</p>
<p><br></p>
</section>
<section id="finding-peaks-with-macs" class="level3">
<h3 class="anchored" data-anchor-id="finding-peaks-with-macs">Finding peaks with MACS</h3>
<p>In our case we have two replicates each containing ChIP and input DNA samples. We will run MACS2 by pooling data (combining two ChIP samples and two inputs, respectively) but a more stringent approach might be to run each replicate separately and look for overlapping peaks.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">macs2</span> callpeak <span class="at">-t</span> bwa_out/Reb1_R1/Reb1_R1.uniq.bam bwa_out/Reb1_R2/Reb1_R2.uniq.bam <span class="at">-c</span> bwa_out/Input_R1/Input_R1.uniq.bam bwa_out/Input_R2/Input_R2.uniq.bam <span class="at">-g</span> 12000000 <span class="at">--nomodel</span> <span class="at">-n</span> Reb1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <strong>-g</strong> flag is the approximate genome size for s.cerevisiae. In this example MACS does not have enough reads to build a shifting model with our reduced number of reads so we skip this step by using <strong>–nomodel</strong>. This should be removed when analysing a complete dataset.</p>
<p>MACS2 will produce three outputs, a peaks.narrowPeak file containing the co-ordinates of peaks, a peaks.xls file of peaks for excel and a summits.bed file with the location of the greatest enrichment within each peak.</p>
<p><br></p>
</section>
<section id="inspecting-peaks" class="level3">
<h3 class="anchored" data-anchor-id="inspecting-peaks">Inspecting Peaks</h3>
<p>Looking at MACS2 data we have 816 peaks. Take a look at the peak calling output, the columns are as follows:</p>
<ol type="1">
<li>Chromosome</li>
<li>Start</li>
<li>End</li>
<li>Iterative id given by MACS2</li>
<li>Integer score for display</li>
<li>Strand (irrelevant in this case)</li>
<li>Fold-change (fold enrichment for this peak summit against random Poisson distribution with local <a href="https://en.wikipedia.org/wiki/Poisson_distribution">lambda</a>)</li>
<li>log10 P-value (e.g., 17.68 is 1 x 10-17)</li>
<li>log10 Q-value from <a href="https://en.wikipedia.org/wiki/False_discovery_rate#Benjamini.E2.80.93Hochberg.E2.80.93Yekutieli_procedure">Benjamini–Hochberg–Yekutieli procedure</a></li>
<li>Relative summit position to peak start</li>
</ol>
<p>You can load the peak files into IGV and see how they correspond to our bigwig tracks.</p>
<p><img src="images/Peaks.png" width="1200"></p>
<p><br></p>
</section>
<section id="what-sequence-motifs-are-found-within-peaks" class="level3">
<h3 class="anchored" data-anchor-id="what-sequence-motifs-are-found-within-peaks">What sequence motifs are found within peaks?</h3>
<p>In this experiment antibodies against Reb1 protein have been used for immunoprecipitaion. The recognition site for Reb1 is TTACCCG (<a href="http://www.sciencedirect.com/science/article/pii/S1097276508008423">Badis:2008</a>). To find out which sequence motifs are found within our peaks we first need to convert coordinates into underlying sequences. The <a href="https://bedtools.readthedocs.io/">bedTools</a> suite has a tool to do this.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bedtools</span> getfasta <span class="at">-fi</span> /homes/genomes/s.cerevisiae/sacCer3/sacCer3.fa <span class="at">-bed</span> Reb1_peaks.narrowPeak <span class="at">-fo</span> Reb1_peaks.fasta <span class="kw">&amp;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now we can run <a href="http://meme-suite.org/">MEME</a> to discover sequence motifs within our data. The <strong>meme-chip</strong> tool is designed specifically for looking for motifs in ChIP-seq data:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">meme-chip</span> Reb1_peaks.fasta</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When complete, MEME will create a new folder called <strong>memechip_out</strong> in your directory and an html (web page) report. See if you can open this in your web browser and find the TTACCCG Reb1 binding motif:</p>
<p><img src="images/meme2.png" width="400"></p>
<p><br></p>
</section>
</section>
<section id="scripting" class="level2">
<h2 class="anchored" data-anchor-id="scripting">3. Scripting</h2>
<p>Putting all of your commands into a script is good practice for keeping track of your analyses and for reproducibility. We want to write scripts so they can be used again on different datasets and avoid <em>hardcoding</em> the names of files.</p>
<p>In the first data processing section we created our alignments (BAM) and visualisation files (bigWig) and this is normally a branching point for downstream analyses that quantify and annotate the data.</p>
<p>Here is a pipeline containing everything up to that point; <a href="http://bifx-core.bio.ed.ac.uk/training/ChIP-seq_workshop/pipeline.sh">pipeline.sh</a></p>
<p>Looking at this pipeline script you’ll notice we are not running parallel every time we run a command, instead we launch the script using parallel and the sample names are passed using the special ‘$1’ bash variable. This is more efficient as the samples will run through each command independently.</p>
<p>Using this we can re-run everything from start to end in one go.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> CS_workshop_tmp <span class="co">#Create a temporary directory</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> CS_workshop_tmp <span class="co">#Move into that directory</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> /homes/library/training/ChIP-seq_workshop/pipeline.sh . <span class="co"># Copy the pipeline into the new directory</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cp</span> ../samples.txt . <span class="co">#Copy the samples file</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nohup</span> cat samples.txt <span class="kw">|</span> <span class="ex">parallel</span> <span class="at">-j</span> 4 bash pipeline.sh {} <span class="op">&gt;</span> pipeline.log <span class="kw">&amp;</span> <span class="co">#Run the shell script (See Below) </span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> .. <span class="co">#Move back to the main directory</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>The <strong>nohup</strong> command stands for <em>no hangup</em> and keeps the process running even if you log out of your command line session.</li>
<li>We use the tool <strong>bash</strong> and the name of our script to run our commands through the shell (‘sh’ will also work).</li>
<li>We then redirect <strong>&gt;</strong> the output to a log file to keep track of any errors.</li>
<li>We use the <strong>&amp;</strong> to run everything in the background to continue using the terminal.</li>
</ul>
<p>You can keep track of your pipeline by using <strong>ps</strong> or looking at the log file.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ps</span> f</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tail</span> CS_workshop_tmp/pipeline.log <span class="co"># Shows the end of a file</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note any commands run on multiple samples will need be to run separately (after pipeline finished)</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">multiqc</span> CS_workshop_tmp/fastq <span class="at">-o</span> CS_workshop_tmp/fastq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<section id="tidy-up" class="level3">
<h3 class="anchored">Tidy Up!</h3>
<p>Files are large, disk space is expensive, remove any unwanted or temporary files from your folder. We should always keep the raw data (fastq) and our final processed datasets (BAM, bigWig etc) and the script we used to generate them. SAM files are large and should be removed once converted to BAM.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> fastq/<span class="pp">*</span>trim<span class="pp">*</span>fq.gz <span class="co">#Remove trimmed fastq temp files</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> bwa_out/<span class="pp">*</span>/<span class="pp">*</span>.sam <span class="co">#Remove sam files</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br></p>
<p>First we want to create a new script for the analysis part of the exercise and we can save all new commands in here. We’ll start by creating and opening a new file called <strong>analysis.sh</strong>. The .sh stands for shell which is essentially just a name for the command line environment. Here we won’t be using parallel.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">emacs</span> <span class="at">-nw</span> analysis.sh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Emacs</strong> is a Unix text editor and the -nw flag opens a new window for editing. Here we are going to paste all of the commands as we go (click the mouse wheel to paste in the terminal):</p>
<p>The <strong>#</strong> symbol indicates a comment line and anything proceeded by a # will not be run by the command line. It is good practice to comment your code. Try adding some comments.</p>
<p>To save and exit the file press <strong>ctrl-x</strong>, followed by <strong>ctrl-c</strong> and then <strong>y</strong> to save.</p>
<p>Although shell scripts save all of your commands they do not necessarily track the versions of software that you use or the current state of your environment and other tool dependencies. More advanced methods of <em>pipelining</em> and <em>containerisation</em> are recommended for fully reproducible analysis and sustainable programming.</p>
<p>Now that we have completed the workshop you should be able to do the following:</p>
<div class="key-points">
<h2 class="anchored" data-anchor-id="tidy-up">
<i class="fas fa-thumbtack"></i>Summary:
</h2>
<ul>
<li>Assess the quality of your experiment</li>
<li>Summarise ChIP-seq profiles across genes</li>
<li>Peak calling</li>
<li>Motif discovery</li>
<li>Create and run shell scripts</li>
</ul>
</div>
<p>Use these links to download the full <a href="http://bifx-core.bio.ed.ac.uk/training/ChIP-seq_workshop/pipeline.sh">pipeline.sh</a> and <a href="http://bifx-core.bio.ed.ac.uk/training/ChIP-seq_workshop/analysis.sh">analysis.sh</a> scripts.</p>
<p>If you are interested in other ways to plot or interrogate your data, the R programming language has many pre-built libraries to specifically analyse genomic data. Several of these are summarised in our <a href="http://bifx-core.bio.ed.ac.uk/training/ROI_workshop/R_roi_workshop.html">genomic regions of interest workshop</a> including gene annotation and plotting ChIP-seq signals. There are also packages for differential binding and statistical analysis. R is a very powerful tool for working with genomic data, applying statistics and creating visualisations. I would highly recommend learning R if you want to perform further downstream analyses.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
    var links = window.document.querySelectorAll('a:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
          // target, if specified
          link.setAttribute("target", "_blank");
      }
    }
});
</script>
</div> <!-- /content -->



</body></html>